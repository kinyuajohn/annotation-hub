<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Annotation Manager - Manage Your Files</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="app-container">
      <header class="app-header">
        <div class="header-content">
          <h1 class="logo">
            <span class="logo-icon">üìä</span>
            Annotation Manager
          </h1>
          <p class="tagline">Manage and organize your shared annotations</p>
        </div>
      </header>

      <main class="main-content">
        <div class="manager-card">
          <div class="card-header">
            <h2>Your Annotations</h2>
            <p>View, manage, and clean up your shared files</p>
          </div>

          <div class="stats-section">
            <div class="stat-card">
              <div class="stat-icon">üìÅ</div>
              <div class="stat-info">
                <h3 id="totalFiles">0</h3>
                <p>Total Files</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">‚úÖ</div>
              <div class="stat-info">
                <h3 id="activeFiles">0</h3>
                <p>Active</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üìÖ</div>
              <div class="stat-info">
                <h3 id="expiredFiles">0</h3>
                <p>Expired</p>
              </div>
            </div>
          </div>

          <div class="actions-section">
            <button class="action-btn primary" onclick="runCleanup()">
              <span class="btn-icon">üßπ</span>
              Cleanup Expired Files
            </button>
            <button
              class="action-btn secondary"
              onclick="window.location.href='index.html'"
            >
              <span class="btn-icon">üì§</span>
              Upload New
            </button>
          </div>

          <div class="annotations-list" id="annotationsList">
            <!-- Annotations will be loaded here -->
          </div>

          <div class="empty-state" id="emptyState" style="display: none">
            <div class="empty-icon">üìã</div>
            <h3>No Annotations Yet</h3>
            <p>Upload your first annotation to get started</p>
            <button
              class="action-btn primary"
              onclick="window.location.href='index.html'"
            >
              Upload Your First File
            </button>
          </div>
        </div>
      </main>

      <footer class="app-footer">
        <p>
          Powered by GitHub Pages ‚Ä¢
          <a href="index.html">Upload New Annotation</a>
        </p>
      </footer>
    </div>

    <script>
      class AnnotationManager {
        constructor() {
          this.metadata = this.loadMetadata();
          this.init();
        }

        init() {
          this.loadAnnotations();
          this.updateStats();
        }

        loadMetadata() {
          try {
            return JSON.parse(
              localStorage.getItem("annotationMetadata") || "{}"
            );
          } catch {
            return {};
          }
        }

        loadAnnotations() {
          const annotationsList = document.getElementById("annotationsList");
          const emptyState = document.getElementById("emptyState");
          const annotations = Object.values(this.metadata);

          if (annotations.length === 0) {
            annotationsList.style.display = "none";
            emptyState.style.display = "block";
            return;
          }

          emptyState.style.display = "none";
          annotationsList.style.display = "block";

          // Sort by creation date (newest first)
          annotations.sort((a, b) => new Date(b.created) - new Date(a.created));

          annotationsList.innerHTML = annotations
            .map((annotation) => {
              const isExpired = new Date(annotation.expiryDate) < new Date();
              const daysLeft = this.getDaysLeft(annotation.expiryDate);

              return `
                        <div class="annotation-item ${
                          isExpired ? "expired" : ""
                        }">
                            <div class="annotation-header">
                                <h4>${annotation.originalName}</h4>
                                <span class="status-badge ${
                                  isExpired ? "expired" : "active"
                                }">
                                    ${
                                      isExpired
                                        ? "EXPIRED"
                                        : `EXPIRES IN ${daysLeft} DAYS`
                                    }
                                </span>
                            </div>
                            <div class="annotation-body">
                                <p class="annotation-desc">${
                                  annotation.description || "No description"
                                }</p>
                                <div class="annotation-meta">
                                    <span class="meta-item">
                                        <span class="meta-icon">üìÖ</span>
                                        Created: ${new Date(
                                          annotation.created
                                        ).toLocaleDateString()}
                                    </span>
                                    <span class="meta-item">
                                        <span class="meta-icon">‚è∞</span>
                                        Expires: ${new Date(
                                          annotation.expiryDate
                                        ).toLocaleDateString()}
                                    </span>
                                    <span class="meta-item">
                                        <span class="meta-icon">üìè</span>
                                        Size: ${
                                          annotation.fileSize || "Unknown"
                                        }
                                    </span>
                                </div>
                                <div class="annotation-url">
                                    <span class="url-label">URL:</span>
                                    <code class="url-code">${
                                      annotation.publicUrl
                                    }</code>
                                </div>
                            </div>
                            <div class="annotation-actions">
                                <button class="action-btn small primary" onclick="viewAnnotation('${
                                  annotation.publicUrl
                                }')">
                                    View
                                </button>
                                <button class="action-btn small" onclick="copyAnnotationLink('${
                                  annotation.publicUrl
                                }')">
                                    Copy Link
                                </button>
                                <button class="action-btn small warning" onclick="deleteAnnotation('${
                                  annotation.id
                                }')">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
            })
            .join("");
        }

        getDaysLeft(expiryDate) {
          const now = new Date();
          const expiry = new Date(expiryDate);
          const diffTime = expiry - now;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          return diffDays > 0 ? diffDays : 0;
        }

        updateStats() {
          const annotations = Object.values(this.metadata);
          const now = new Date();

          const totalFiles = annotations.length;
          const activeFiles = annotations.filter(
            (a) => new Date(a.expiryDate) >= now
          ).length;
          const expiredFiles = totalFiles - activeFiles;

          document.getElementById("totalFiles").textContent = totalFiles;
          document.getElementById("activeFiles").textContent = activeFiles;
          document.getElementById("expiredFiles").textContent = expiredFiles;
        }
      }

      // Global functions
      function viewAnnotation(url) {
        window.open(url, "_blank");
      }

      function copyAnnotationLink(url) {
        navigator.clipboard.writeText(url).then(() => {
          alert("Link copied to clipboard!");
        });
      }

      function deleteAnnotation(id) {
        if (
          confirm(
            "Are you sure you want to delete this annotation? This will remove it from your local storage."
          )
        ) {
          const metadata = JSON.parse(
            localStorage.getItem("annotationMetadata") || "{}"
          );
          delete metadata[id];
          localStorage.setItem("annotationMetadata", JSON.stringify(metadata));

          // Reload the page to reflect changes
          window.location.reload();
        }
      }

      function runCleanup() {
        const metadata = JSON.parse(
          localStorage.getItem("annotationMetadata") || "{}"
        );
        const now = new Date();
        let deletedCount = 0;

        Object.keys(metadata).forEach((id) => {
          if (new Date(metadata[id].expiryDate) < now) {
            delete metadata[id];
            deletedCount++;
          }
        });

        localStorage.setItem("annotationMetadata", JSON.stringify(metadata));

        if (deletedCount > 0) {
          alert(
            `Cleaned up ${deletedCount} expired annotations from local storage.\n\nRemember to also delete the actual HTML files from your annotations/ folder and run:\n\ngit add .\ngit commit -m "chore: remove expired annotations"\ngit push origin main`
          );
        } else {
          alert("No expired annotations found to clean up.");
        }

        window.location.reload();
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", () => {
        new AnnotationManager();
      });
    </script>

    <style>
      .manager-card {
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow-xl);
        overflow: hidden;
      }

      .stats-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        padding: 0 2rem 2rem;
      }

      .stat-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        background: var(--secondary-color);
        border-radius: var(--radius);
        border: 1px solid var(--border-color);
      }

      .stat-icon {
        font-size: 2rem;
        opacity: 0.7;
      }

      .stat-info h3 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.25rem;
      }

      .stat-info p {
        color: var(--text-secondary);
        font-size: 0.875rem;
      }

      .actions-section {
        padding: 0 2rem 2rem;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .annotations-list {
        padding: 0 2rem 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .annotation-item {
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 1.5rem;
        background: white;
        transition: var(--transition);
      }

      .annotation-item:hover {
        box-shadow: var(--shadow);
      }

      .annotation-item.expired {
        opacity: 0.7;
        background: var(--secondary-color);
      }

      .annotation-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
      }

      .annotation-header h4 {
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-badge.active {
        background: #d1fae5;
        color: #065f46;
      }

      .status-badge.expired {
        background: #fee2e2;
        color: #991b1b;
      }

      .annotation-desc {
        color: var(--text-secondary);
        margin-bottom: 1rem;
      }

      .annotation-meta {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-light);
      }

      .meta-icon {
        font-size: 1rem;
      }

      .annotation-url {
        margin-bottom: 1rem;
      }

      .url-label {
        font-weight: 500;
        font-size: 0.875rem;
        margin-right: 0.5rem;
      }

      .url-code {
        background: var(--secondary-color);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
        color: var(--primary-color);
        word-break: break-all;
      }

      .annotation-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .action-btn.small {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }

      .action-btn.warning {
        background: var(--error-color);
        color: white;
      }

      .action-btn.warning:hover {
        background: #dc2626;
      }

      .empty-state {
        text-align: center;
        padding: 4rem 2rem;
      }

      .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
      }

      .empty-state p {
        color: var(--text-secondary);
        margin-bottom: 2rem;
      }

      @media (max-width: 768px) {
        .stats-section {
          grid-template-columns: 1fr;
          padding: 0 1rem 1rem;
        }

        .actions-section {
          padding: 0 1rem 1rem;
          flex-direction: column;
        }

        .annotations-list {
          padding: 0 1rem 1rem;
        }

        .annotation-header {
          flex-direction: column;
          gap: 0.5rem;
        }

        .annotation-meta {
          flex-direction: column;
          gap: 0.5rem;
        }
      }
    </style>
  </body>
</html>
